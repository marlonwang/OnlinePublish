(function(b){var a=Ku6.Api;b.Toolbar={$name:b.$name+".Toolbar",tipMsg:["验证处理中,请稍等...","用户名不能为空","用户名不能含有中文字符(老用户除外)","用户名长度4-16位(1中文占2位)","密码不能为空","密码不能含有中文字符","密码长度4-16位","用户名不存在","密码错误","发生未知错误,请重试!"],isLogined:function(){this.profile=this.profile||Ku6.User.Passport.get();return this.profile},getUrls:function(){if(!this.urls){var c=this.profile||this.isLogined();this.urls={space:Ku6.Utils.getSpaceUrl(c.uid,c.url),podcast:Ku6.Utils.getPodcastUrl(c.uid,c.url)}}return this.urls},login:function(){App.Logon.login()},redirect:function(c){c=c||window;c.location[c.location.href.indexOf("#")>-1?"reload":"assign"](c.location.href)},logout:function(c){App.Logon.logout(c)},build:function(e){this.element=$(e)||this.element;this.forms=this.element.getElements("form");this.bound={count:this.setMessageStatus.bind(this),breathe:this.onBreathe.bind(this)};var d=this;App.Logon.setReferKey("group").setIbw(IbwHelper.enable).setSsoHost("http://"+location.hostname).setDm(document.domain).addEvents({wait:function(){alert("页面正在打开，请稍候…")},update:function(f,h){if(h&&!f){var g=$("loginBtn",true);if(g){$(g).set("text","进入酷6")}}},logon:function(f,g){if(g>1){(function(){d.redirect()}).delay(window.SYNC_WAIT||3000,this)}}}).init("logonBar");if(this.isLogined()){this.getUrls();this.element.removeClass("nologin_nav").getElement(".nav_left").set("html",'<a href="http://zone.ku6.com/welcome.htm">空间</a> | <a href="../出错页_files/'+this.urls.space+'">主页</a> | <a href="../出错页_files/'+this.urls.podcast+'">播客</a> | <a href="http://zone.ku6.com/group/">我的群</a>');var c=[];c.push('<a href="#" onclick="'+this.$name+'.logout(event)">退出</a> | ');c.push('<a href="../出错页_files/'+Ku6.Urls.space+'/help/index.html" target="blank">帮助</a>');this.panel=this.element.getElement(".nav_my").set("html",c.join("")).addClass("rel");this.buildUserBar()}else{this.buildUserForm()}this.buildSearchForm()},go:function(){var c=this;Ku6.Api.Group.isGroupUser({async:false,data:{userId:this.profile.id},events:{onSuccess:function(){location.href="http://group.ku6.com/user.htm?t=index"},onFailure:function(){App.Confirm({title:"信息确认",content:"系统检测到您还未创建或加入任何群组，是否需要创建新群组？",doOk:function(){location.href="http://group.ku6.com/creategroup.htm?t=create"}})}}})},onBreathe:function(){var c=$time();if(c-this.time>=60000){this.time=c}},buildUserBar:function(){this.messager=this.panel.getElement("a");this.messager.getNext("a").addEvent("click",this.toggleThemeSetting.bindWithEvent(this));this.time=0;document.addEvent("mousemove",this.bound.breathe);if(this.getThemeStatus()){this.toggleThemeSetting()}},buildUserForm:function(){var c=$("loginBtn",true);if(c){$(c).addEvent("click",this.doLogin.bind(this))}},buildSearchForm:function(){var c=this.forms[0];this.key=c.elements.q;c.onsubmit=null;c.action=Ku6.Utils.getSpaceUrl(0,"so")+"/e";c.addEvent("submit",this.doSearch.bind(this))},doLogin:function(){this.login();return false},doSearch:function(){var c=this.key.value.trim();if(c){window.open(this.forms[0].action+"?q="+encodeURIComponent(c))}return false},getNewCount:function(){a.Message.getNewCount({events:{onSuccess:this.bound.count,onFailure:this.bound.count}})},setMessageStatus:function(e){var c=this.urls.space+"/message/";if(e&&e.count>0){var d={mcount:0,scount:2,fcount:3};Hash.some(d,function(g,f){if(e[f]>0){c+="#"+g}return e[f]>0});this.messager.addClass("xxi").set("html",'消息( <span class="cf00">'+e.count+"</span> )")}else{this.messager.removeClass("xxi").set("text","消息")}this.messager.set("href",c);this.time=$time()},setThemeStatus:function(){location.href=(location.hostname==Ku6.Urls._space?(Ku6.Urls.space+"/u/"+this.profile.uid):(this.urls.space+"/"))+"#ts"},getThemeStatus:function(){var c=location.hash;return c=="#ts"||c=="#tsc"},isMyHome:function(){var f=Ku6.Urls._space,d=location.hostname,g=location.pathname,e=this.profile.domain,c=this.profile.uid;return e+"."+f==d&&g=="/"||d==f&&(g=="/u/"+c||g=="/u/"+c+"/")},toggleThemeSetting:function(c){c&&c.preventDefault();if(this.isMyHome()){window.addEvent("domready",function(){var d=using("App.Manager.Theme");if(d.toggle){d.toggle(this.element)}}.bind(this))}else{this.setThemeStatus()}}};window.addEvent("domready",function(){b.Toolbar.build("toolbar")})})(using("App"));